2026-02-04 23:10
Tags: #Interview #golang #interface

- [Опишите внутреннее устройство интерфейса iface (для типов с методами) и eface (для any).](#Опишите%20внутреннее%20устройство%20интерфейса%20iface%20(для%20типов%20с%20методами)%20и%20eface%20(для%20any).)
- [Что такое itab в структуре интерфейса? Какую информацию он хранит?](#Что%20такое%20itab%20в%20структуре%20интерфейса?%20Какую%20информацию%20он%20хранит?)
- [Почему сравнение интерфейса с nil может вернуть false, даже если значение внутри — nil?](#Почему%20сравнение%20интерфейса%20с%20nil%20может%20вернуть%20false,%20даже%20если%20значение%20внутри%20—%20nil?)

---

### Опишите внутреннее устройство интерфейса iface (для типов с методами) и eface (для any).

В Go интерфейсы реализованы через две внутренние структуры рантайма: **`eface`** (для пустого интерфейса) и **`iface`** (для интерфейсов с методами). Обе хранят значение и информацию о его типе, но `iface` дополнительно содержит таблицу методов.

##### `eface` — пустой интерфейс (`interface{}` / `any`)
Используется для `interface{}`. Структура содержит два поля:
```go
type eface struct {
    _type *_type  // указатель на описание динамического типа
    data  unsafe.Pointer  // указатель на фактические данные
}
```
- `_type` — дескриптор типа (структура `_type` из рантайма), содержит информацию о размере, выравнивании, методах и т.д.
- `data` — указатель на само значение (или само значение, если оно помещается в один машинный слово).
```go
var x any = 42
// x хранится как eface:
//   _type → *int
//   data  → 42
```

##### `iface` — интерфейс с методами
Используется для именованных интерфейсов вроде `io.Reader`, `error` и т.д.:
```go
type iface struct {
    tab  *itab        // таблица интерфейса + тип
    data unsafe.Pointer  // указатель на данные
}
```

---

### Что такое itab в структуре интерфейса? Какую информацию он хранит?

`itab` (**interface table**) — это ключевая структура рантайма Go, которая кэширует соответствие между **конкретным типом** и **интерфейсом**, который он реализует. Она позволяет эффективно вызывать методы через интерфейс без повторной проверки соответствия при каждом вызове.

Структура `itab` (упрощённо)
```go
type itab struct {
    inter  *interfacetype// дескриптор интерфейса (какие методы требуются)
    _type  *_type // дескриптор конкретного типа (какие методы есть)
    hash   uint32 // хеш-сумма пары (интерфейс, тип) для быстрого поиска
    _      [4]byte // паддинг для выравнивания (на 64-битных системах)
    fun    [1]uintptr // массив указателей на реализации методов
}
```

| Поле    | Назначение                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `inter` | Указатель на `interfacetype` — статическое описание интерфейса: его имя, количество методов, сигнатуры методов.                                                                                                                                                                                                                                                                                                                         |
| `_type` | Указатель на `_type` — дескриптор динамического типа значения (например, `*os.File`). Содержит информацию о методах типа, размере, выравнивании и т.д.                                                                                                                                                                                                                                                                                  |
| `hash`  | Предвычисленный хеш от пары `(интерфейс, тип)`. Используется для быстрого сравнения и поиска в кэше `itab`.                                                                                                                                                                                                                                                                                                                             |
| `fun`   | **Массив указателей на функции** — главная «магия» `itab`. Для каждого метода интерфейса здесь хранится указатель на его реализацию конкретным типом. При вызове `reader.Read()` рантайм просто берёт `itab.fun[0]` и вызывает функцию напрямую — без поиска по таблице методов.<br>При вызове `reader.Read()` происходит:<br>1. Получение `itab` из `iface.tab`<br>2. Поиск нужного метода в `itab.fun[N]`<br>3. Вызов через указатель |

---

### Почему сравнение интерфейса с nil может вернуть false, даже если значение внутри — nil?

В Go интерфейс — это **не просто указатель**. Внутренне он представляет собой структуру из **двух компонентов**:

1. **Динамический тип** (type) — конкретный тип значения, реализующего интерфейс
2. **Динамическое значение** (value) — само значение этого типа

Интерфейс считается равным `nil` **только когда оба компонента равны `nil`** одновременно.

---
### Links
[[Base/Interview/Golang/Golang|Golang]]